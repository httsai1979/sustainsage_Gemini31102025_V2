<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¸æ“‡å›°å¢ƒé‡æ¸…å™¨</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter & Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- jsPDF and html2canvas for export functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Custom Styles to enhance Tailwind */
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #F6F2EA;
            color: #1F2933;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            background: #fff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 8px 30px rgba(31, 41, 51, 0.08);
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #E5DED0;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            color: #1F2933;
        }
        .input-field:focus {
            outline: none;
            border-color: #4A6C56;
            box-shadow: 0 0 0 3px rgba(74, 108, 86, 0.2);
        }
        .btn-primary {
            background-color: #4A6C56;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            transition: all 0.3s ease;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #3B5444;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:disabled {
            background-color: #CBD5C0;
            cursor: not-allowed;
        }
        .option-card {
            background-color: #FBF8F1;
            border: 1px solid #E5DED0;
            transition: all 0.2s;
        }
        .option-card.active {
            border-color: #4A6C56;
            background-color: #E3EAE3;
        }
        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .mood-emoji {
            font-size: 1.5rem;
            line-height: 1;
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 9999px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: visibility 0s, opacity 0.5s linear;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chart-container {
            width: 100%;
            height: 400px;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container rounded-2xl shadow-xl flex flex-col gap-8">

        <!-- Header -->
        <header class="text-center">
            <h1 class="text-3xl font-bold mb-2">é¸æ“‡å›°å¢ƒé‡æ¸…å™¨ <i class="fas fa-shuffle"></i></h1>
            <p class="text-gray-500 mb-4">çµåˆç†æ€§åˆ†æèˆ‡æƒ…ç·’æ´å¯Ÿï¼Œå”åŠ©æ‚¨åšå‡ºæ›´å…¨é¢çš„æ±ºç­–ã€‚</p>
            <div id="step-indicator" class="text-sm font-medium text-gray-400"></div>
        </header>

        <!-- Step Content Area -->
        <div id="step-content" class="min-h-[400px] flex flex-col justify-center items-center text-center fade-in">
            <!-- Content will be dynamically injected here -->
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-between items-center mt-6">
            <button id="prev-btn" class="btn-primary px-6 py-2 rounded-full font-medium transition-all" disabled>
                <i class="fas fa-arrow-left mr-2"></i> ä¸Šä¸€æ­¥
            </button>
            <button id="next-btn" class="btn-primary px-6 py-2 rounded-full font-medium transition-all">
                ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>

    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // ==== Global State Management ====
        let currentStep = 0;
        let myChart;
        const appState = {
            decisionQuestion: '',
            options: ['', ''],
            scores: {
                rational: [
                    { feasibility: 3, financial: 3, potential: 3 },
                    { feasibility: 3, financial: 3, potential: 3 },
                    { feasibility: 3, financial: 3, potential: 3 }
                ],
                emotional: [
                    { confidence: 3, anxiety: 3, curiosity: 3, joy: 3 },
                    { confidence: 3, anxiety: 3, curiosity: 3, joy: 3 },
                    { confidence: 3, anxiety: 3, curiosity: 3, joy: 3 }
                ]
            },
            reflections: {
                alignedOption: '',
                fearlessChoice: '',
                nextSteps: ''
            }
        };
        const toastElement = document.getElementById('toast');
        const rationalCriteria = [
            { id: 'feasibility', name: 'å¯è¡Œæ€§', tip: 'é€™å€‹é¸é …çš„å¯¦ç¾é›£åº¦æœ‰å¤šé«˜ï¼Ÿ' },
            { id: 'financial', name: 'è²¡å‹™å½±éŸ¿', tip: 'é€™å€‹é¸é …æœƒå°æˆ‘çš„è²¡å‹™ç‹€æ³é€ æˆä»€éº¼å½±éŸ¿ï¼Ÿ' },
            { id: 'potential', name: 'é•·æœŸæ½›åŠ›', tip: 'é€™å€‹é¸é …èƒ½å¸¶çµ¦æˆ‘å¤šå°‘é•·é çš„æˆé•·æˆ–åƒ¹å€¼ï¼Ÿ' }
        ];
        const emotionalCriteria = [
            { id: 'confidence', name: 'ä¿¡å¿ƒ', emoji: 'ğŸ’ª', color: '#34d399' },
            { id: 'anxiety', name: 'ç„¦æ…®', emoji: 'ğŸ˜Ÿ', color: '#f87171' },
            { id: 'curiosity', name: 'å¥½å¥‡', emoji: 'ğŸ¤”', color: '#60a5fa' },
            { id: 'joy', name: 'å–œæ‚…', emoji: 'ğŸ¥³', color: '#fcd34d' }
        ];
        const optionsLetters = ['A', 'B', 'C'];
        
        // ==== Step Definitions ====
        const steps = [
            {
                title: "ç¬¬ä¸€æ­¥ï¼šå®šç¾©ä½ çš„å›°å¢ƒ",
                description: "è«‹ç”¨ä¸€å¥è©±æ¸…æ¥šåœ°æè¿°ä½ éœ€è¦åšå‡ºçš„æ±ºç­–ã€‚",
                content: () => `
                    <textarea id="question-input" class="input-field h-24 resize-none" placeholder="ä¾‹å¦‚ï¼šæˆ‘æ‡‰è©²é›¢è·å»å‰µæ¥­ï¼Œé‚„æ˜¯ç¹¼çºŒç•™åœ¨ç¾åœ¨çš„å…¬å¸ï¼Ÿ">${appState.decisionQuestion}</textarea>
                `,
                validate: () => appState.decisionQuestion.trim() !== ''
            },
            {
                title: "ç¬¬äºŒæ­¥ï¼šåˆ—å‡ºä½ çš„é¸é …",
                description: "è«‹å¯«ä¸‹æœ€å¤šä¸‰å€‹å¯èƒ½çš„é¸æ“‡ã€‚ä¸€å€‹å¥½çš„é¸é …æ˜¯å…·é«”çš„ã€‚",
                content: () => `
                    <div class="space-y-4 w-full">
                        ${appState.options.map((option, index) => `
                            <div class="flex items-center gap-2">
                                <span class="text-lg font-bold w-6 text-center">${optionsLetters[index]}</span>
                                <input type="text" id="option-${index}" class="input-field flex-grow" placeholder="é¸é … ${optionsLetters[index]}" value="${option}">
                                ${index > 1 ? `<button class="remove-option-btn text-gray-500 hover:text-red-500" data-index="${index}"><i class="fas fa-trash"></i></button>` : ''}
                            </div>
                        `).join('')}
                    </div>
                    ${appState.options.length < 3 ? `
                        <div class="mt-4 w-full text-center">
                            <button id="add-option-btn" class="btn-primary px-4 py-2 text-sm rounded-full">
                                <i class="fas fa-plus mr-1"></i> æ–°å¢é¸é …
                            </button>
                        </div>
                    ` : ''}
                `,
                validate: () => appState.options.filter(o => o.trim() !== '').length >= 2
            },
            {
                title: "ç¬¬ä¸‰æ­¥ï¼šç†æ€§è©•ä¼°",
                description: "è«‹ç‚ºæ¯å€‹é¸é …ï¼Œæ ¹æ“šä»¥ä¸‹æ¨™æº–é€²è¡Œè©•åˆ†ï¼ˆ1åˆ†ï¼šéå¸¸ä¸ä½³ï¼Œ5åˆ†ï¼šéå¸¸å„ªç§€ï¼‰ã€‚",
                content: () => `
                    <div class="space-y-8 w-full">
                        ${appState.options.filter(o => o.trim() !== '').map((option, optIndex) => `
                            <div class="p-6 rounded-lg shadow-md option-card">
                                <h3 class="text-xl font-bold mb-4">é¸é … ${optionsLetters[optIndex]}: ${option}</h3>
                                ${rationalCriteria.map(criteria => `
                                    <div class="mb-4">
                                        <div class="slider-label mb-1">
                                            <span class="font-medium">${criteria.name}</span>
                                            <span id="rational-${optIndex}-${criteria.id}-value">${appState.scores.rational[optIndex][criteria.id]}</span>
                                        </div>
                                        <input type="range" min="1" max="5" value="${appState.scores.rational[optIndex][criteria.id]}" class="w-full h-2 bg-blue-100 rounded-lg appearance-none cursor-pointer slider" id="rational-${optIndex}-${criteria.id}">
                                    </div>
                                `).join('')}
                            </div>
                        `).join('')}
                    </div>
                `,
                validate: () => true
            },
            {
                title: "ç¬¬å››æ­¥ï¼šæƒ…ç·’æ´å¯Ÿ",
                description: "æƒ³åƒä½ é¸æ“‡äº†è©²é¸é …ï¼Œä½ çš„å…§å¿ƒæœƒæœ‰ä»€éº¼æ„Ÿè¦ºï¼Ÿè«‹ç‚ºæ¯å€‹é¸é …è©•åˆ†ï¼ˆ1åˆ†ï¼šæ„Ÿå—å¾ˆä½ï¼Œ5åˆ†ï¼šæ„Ÿå—å¾ˆå¼·çƒˆï¼‰ã€‚",
                content: () => `
                    <div class="space-y-8 w-full">
                        ${appState.options.filter(o => o.trim() !== '').map((option, optIndex) => `
                            <div class="p-6 rounded-lg shadow-md option-card">
                                <h3 class="text-xl font-bold mb-4">é¸é … ${optionsLetters[optIndex]}: ${option}</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    ${emotionalCriteria.map(criteria => `
                                        <div>
                                            <div class="slider-label mb-1">
                                                <span class="font-medium flex items-center gap-2">${criteria.name} <span class="mood-emoji">${criteria.emoji}</span></span>
                                                <span id="emotional-${optIndex}-${criteria.id}-value">${appState.scores.emotional[optIndex][criteria.id]}</span>
                                            </div>
                                            <input type="range" min="1" max="5" value="${appState.scores.emotional[optIndex][criteria.id]}" class="w-full h-2 rounded-lg appearance-none cursor-pointer slider" id="emotional-${optIndex}-${criteria.id}" style="background-color: ${criteria.color}40;">
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `,
                validate: () => true
            },
            {
                title: "ç¬¬äº”æ­¥ï¼šç¸½çµèˆ‡ä¸‹ä¸€æ­¥è¡Œå‹•",
                description: "æ­å–œæ‚¨å®Œæˆäº†åˆ†æï¼é€™å¼µç¸½çµåœ–è¡¨å°‡å¹«åŠ©æ‚¨åšå‡ºæ±ºç­–ã€‚",
                content: () => `
                    <div id="summary-report" class="w-full text-left flex flex-col gap-6">
                        <h3 class="text-2xl font-bold">æ±ºç­–å•é¡Œ</h3>
                        <p class="text-gray-600">${appState.decisionQuestion}</p>

                        <h3 class="text-2xl font-bold mt-4">ç†æ€§è©•ä¼°åœ– (é›·é”åœ–)</h3>
                        <div class="w-full h-96">
                            <canvas id="rational-chart"></canvas>
                        </div>

                        <h3 class="text-2xl font-bold mt-4">æƒ…ç·’åœ°åœ– (æ„Ÿå—åˆ†ä½ˆ)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${appState.options.filter(o => o.trim() !== '').map((option, optIndex) => `
                                <div class="p-4 rounded-lg shadow-md border-2 border-gray-200">
                                    <h4 class="font-bold text-lg mb-2">é¸é … ${optionsLetters[optIndex]}: ${option}</h4>
                                    <ul class="space-y-2">
                                        ${emotionalCriteria.map(criteria => `
                                            <li class="flex items-center gap-2">
                                                <span class="mood-emoji">${criteria.emoji}</span>
                                                <span class="text-sm font-medium">${criteria.name}ï¼š${appState.scores.emotional[optIndex][criteria.id]} / 5</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>

                        <h3 class="text-2xl font-bold mt-6">åæ€èˆ‡æ´å¯Ÿ</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="reflection-aligned" class="block text-lg font-bold mb-2">å“ªå€‹é¸é …è®“ä½ ã€Œæ„Ÿè¦ºã€æœ€å°ï¼Ÿ</label>
                                <textarea id="reflection-aligned" class="input-field h-20 resize-none" placeholder="å³ä½¿ç†æ€§åˆ†æä¸ç›¡å®Œç¾ï¼Œå“ªå€‹é¸é …æœ€è²¼è¿‘ä½ çš„å…§å¿ƒï¼Ÿ">${appState.reflections.alignedOption}</textarea>
                            </div>
                            <div>
                                <label for="reflection-fearless" class="block text-lg font-bold mb-2">å¦‚æœææ‡¼ä¸æ˜¯å•é¡Œï¼Œä½ æœƒé¸æ“‡ä»€éº¼ï¼Ÿ</label>
                                <textarea id="reflection-fearless" class="input-field h-20 resize-none" placeholder="é€™å€‹å•é¡Œèƒ½å¹«åŠ©ä½ å€åˆ†ã€è¬¹æ…ã€å’Œã€ææ‡¼ã€ã€‚">${appState.reflections.fearlessChoice}</textarea>
                            </div>
                        </div>

                        <h3 class="text-2xl font-bold mt-6">ä¸‹ä¸€æ­¥è¡Œå‹•</h3>
                        <p class="text-gray-500">è¦åŠƒ 1-3 å€‹å°æ­¥é©Ÿï¼Œé©—è­‰ä½ çš„æƒ³æ³•æˆ–é™ä½æ±ºç­–é¢¨éšªã€‚</p>
                        <textarea id="next-steps-input" class="input-field h-32 resize-none" placeholder="ä¾‹å¦‚ï¼š1. èˆ‡æ¥­ç•Œæœ‹å‹èŠèŠï¼›2. é ç´„ä¸€å ´è«®è©¢ï¼›3. èŠ±ä¸€å°æ™‚ç ”ç©¶æ–°æŠ€èƒ½ã€‚">${appState.reflections.nextSteps}</textarea>
                        
                        <div id="export-buttons" class="mt-6 flex justify-center gap-4">
                            <button id="export-pdf-btn" class="btn-primary flex items-center gap-2">
                                <i class="fas fa-file-pdf"></i> åŒ¯å‡ºç‚º PDF
                            </button>
                        </div>
                    </div>
                `,
                validate: () => true
            }
        ];

        // ==== UI Rendering & Logic ====
        function renderStep() {
            const stepContent = document.getElementById('step-content');
            stepContent.innerHTML = '';
            const stepData = steps[currentStep];

            const headerHtml = `
                <div class="w-full text-left mb-6 fade-in">
                    <h2 class="text-2xl font-bold">${stepData.title}</h2>
                    <p class="text-gray-500 mt-2">${stepData.description}</p>
                </div>
            `;
            stepContent.insertAdjacentHTML('beforeend', headerHtml);
            stepContent.insertAdjacentHTML('beforeend', stepData.content());

            setupEventListenersForStep();
            updateNavigation();
            saveState(); // Save state on every render
        }

        function setupEventListenersForStep() {
            if (currentStep === 0) {
                const questionInput = document.getElementById('question-input');
                questionInput.addEventListener('input', (e) => {
                    appState.decisionQuestion = e.target.value;
                    updateNavigation();
                });
            } else if (currentStep === 1) {
                appState.options.forEach((_, index) => {
                    const input = document.getElementById(`option-${index}`);
                    if (input) {
                        input.addEventListener('input', (e) => {
                            appState.options[index] = e.target.value;
                            updateNavigation();
                        });
                    }
                });
                const addBtn = document.getElementById('add-option-btn');
                if (addBtn) {
                    addBtn.addEventListener('click', () => {
                        if (appState.options.length < 3) {
                            appState.options.push('');
                            appState.scores.rational.push({ feasibility: 3, financial: 3, potential: 3 });
                            appState.scores.emotional.push({ confidence: 3, anxiety: 3, curiosity: 3, joy: 3 });
                            renderStep();
                        }
                    });
                }
                document.querySelectorAll('.remove-option-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const indexToRemove = parseInt(e.currentTarget.dataset.index, 10);
                        appState.options.splice(indexToRemove, 1);
                        appState.scores.rational.splice(indexToRemove, 1);
                        appState.scores.emotional.splice(indexToRemove, 1);
                        renderStep();
                    });
                });
            } else if (currentStep === 2) {
                rationalCriteria.forEach(criteria => {
                    appState.options.forEach((_, optIndex) => {
                        const slider = document.getElementById(`rational-${optIndex}-${criteria.id}`);
                        if (slider) {
                            const valueSpan = document.getElementById(`rational-${optIndex}-${criteria.id}-value`);
                            slider.addEventListener('input', (e) => {
                                appState.scores.rational[optIndex][criteria.id] = parseInt(e.target.value, 10);
                                valueSpan.textContent = e.target.value;
                                saveState();
                            });
                        }
                    });
                });
            } else if (currentStep === 3) {
                emotionalCriteria.forEach(criteria => {
                    appState.options.forEach((_, optIndex) => {
                        const slider = document.getElementById(`emotional-${optIndex}-${criteria.id}`);
                        if (slider) {
                            const valueSpan = document.getElementById(`emotional-${optIndex}-${criteria.id}-value`);
                            slider.addEventListener('input', (e) => {
                                appState.scores.emotional[optIndex][criteria.id] = parseInt(e.target.value, 10);
                                valueSpan.textContent = e.target.value;
                                saveState();
                            });
                        }
                    });
                });
            } else if (currentStep === 4) {
                // Summary Page Logic
                renderRationalChart();
                document.getElementById('reflection-aligned').addEventListener('input', (e) => {
                    appState.reflections.alignedOption = e.target.value;
                    saveState();
                });
                document.getElementById('reflection-fearless').addEventListener('input', (e) => {
                    appState.reflections.fearlessChoice = e.target.value;
                    saveState();
                });
                document.getElementById('next-steps-input').addEventListener('input', (e) => {
                    appState.reflections.nextSteps = e.target.value;
                    saveState();
                });
                document.getElementById('export-pdf-btn').addEventListener('click', exportAsPDF);
            }
        }

        function renderRationalChart() {
            const ctx = document.getElementById('rational-chart');
            if (myChart) {
                myChart.destroy();
            }

            const data = {
                labels: rationalCriteria.map(c => c.name),
                datasets: appState.options.filter(o => o.trim() !== '').map((option, index) => ({
                    label: `é¸é … ${optionsLetters[index]}: ${option}`,
                    data: rationalCriteria.map(c => appState.scores.rational[index][c.id]),
                    fill: true,
                    backgroundColor: `rgba(74, 108, 86, 0.18)`,
                    borderColor: `#4A6C56`,
                    pointBackgroundColor: `#4A6C56`,
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: `#4A6C56`
                }))
            };

            const config = {
                type: 'radar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: '#E5DED0' },
                            grid: { color: '#E5DED0' },
                            pointLabels: {
                                font: { size: 14, family: 'Noto Sans TC' }
                            },
                            ticks: {
                                display: false,
                                maxTicksLimit: 5
                            },
                            suggestedMin: 0,
                            suggestedMax: 5
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Noto Sans TC'
                                }
                            }
                        }
                    }
                }
            };
            myChart = new Chart(ctx, config);
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const stepIndicator = document.getElementById('step-indicator');
            const stepData = steps[currentStep];

            prevBtn.disabled = currentStep === 0;
            const nextBtnText = currentStep === steps.length - 1 ? 'é‡æ–°é–‹å§‹' : 'ä¸‹ä¸€æ­¥';
            nextBtn.innerHTML = `${nextBtnText} <i class="fas fa-arrow-right ml-2"></i>`;
            
            const isValid = stepData.validate();
            nextBtn.disabled = !isValid && currentStep < steps.length - 1;

            stepIndicator.textContent = `æ­¥é©Ÿ ${currentStep + 1} / ${steps.length}`;
        }
        
        function navigateToNextStep() {
            const stepData = steps[currentStep];
            if (currentStep === steps.length - 1) {
                // Reset and restart
                currentStep = 0;
                Object.assign(appState, {
                    decisionQuestion: '',
                    options: ['', ''],
                    scores: {
                        rational: [{ feasibility: 3, financial: 3, potential: 3 }, { feasibility: 3, financial: 3, potential: 3 }],
                        emotional: [{ confidence: 3, anxiety: 3, curiosity: 3, joy: 3 }, { confidence: 3, anxiety: 3, curiosity: 3, joy: 3 }]
                    },
                    reflections: {
                        alignedOption: '',
                        fearlessChoice: '',
                        nextSteps: ''
                    }
                });
                showToast('å·²é‡è¨­ï¼Œè®“æˆ‘å€‘é‡æ–°é–‹å§‹å§ï¼', 'success');
            } else if (stepData.validate()) {
                currentStep++;
            } else {
                showToast('è«‹å®Œæˆæ­¤æ­¥é©Ÿçš„å…§å®¹ã€‚', 'error');
            }
            renderStep();
        }

        function navigateToPrevStep() {
            if (currentStep > 0) {
                currentStep--;
                renderStep();
            }
        }

        // ==== Utility Functions ====
        function showToast(message, type = 'info') {
            toastElement.textContent = message;
            toastElement.className = `show rounded-full px-6 py-3 text-white shadow-xl ${type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`;
            setTimeout(() => {
                toastElement.className = toastElement.className.replace('show', '');
            }, 3000);
        }

        async function exportAsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            const element = document.getElementById('summary-report');

            const loadingToast = document.createElement('div');
            loadingToast.textContent = 'æ­£åœ¨æº–å‚™åŒ¯å‡º...';
            loadingToast.className = 'toast show bg-blue-500';
            document.body.appendChild(loadingToast);

            try {
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#f0f4f8'
                });

                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 595.28;
                const pageHeight = 841.89;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                doc.save('æˆ‘çš„é¸æ“‡å›°å¢ƒé‡æ¸…å™¨ç¸½çµ.pdf');
                showToast('å·²åŒ¯å‡ºç‚º PDF', 'success');
            } catch (err) {
                showToast('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
                console.error('åŒ¯å‡º PDF å¤±æ•—:', err);
            } finally {
                loadingToast.remove();
            }
        }

        // ==== State Persistence (using localStorage) ====
        function saveState() {
            localStorage.setItem('decisionMatrixState', JSON.stringify(appState));
            localStorage.setItem('decisionMatrixStep', currentStep);
        }

        function loadState() {
            const savedState = localStorage.getItem('decisionMatrixState');
            const savedStep = localStorage.getItem('decisionMatrixStep');
            if (savedState) {
                Object.assign(appState, JSON.parse(savedState));
            }
            if (savedStep) {
                currentStep = parseInt(savedStep, 10);
            }
        }

        // ==== Application Initialization ====
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            renderStep();
            document.getElementById('prev-btn').addEventListener('click', navigateToPrevStep);
            document.getElementById('next-btn').addEventListener('click', navigateToNextStep);
        });
    </script>
</body>
</html>
