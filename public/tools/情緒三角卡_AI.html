<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒ…ç·’ä¸‰è§’å¡ | Emotion Triangle</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fontsï¼šInter ä½œç‚ºåŸºç¤å­—é«”ï¼ŒNoto Sans TC ä½œç‚ºä¸­æ–‡å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Font Awesome 6.4.0 åœ–ç¤ºåº« -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- å¼•å…¥ html2canvas å’Œ jspdf ç”¨æ–¼åŒ¯å‡ºåŠŸèƒ½ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* è‡ªå®šç¾©æ¨£å¼è¦†å¯« Tailwind */
        :root {
            --primary-color: #3475cf;
            --primary-light: #e0f0ff;
            --text-color: #1a457c;
            --bg-color: #f0f4f8;
            --card-bg: #fff;
            --border-color: #d1d5db;
        }

        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(52, 117, 207, 0.1);
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            color: var(--text-color);
        }
        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 117, 207, 0.2);
        }
        .input-field::placeholder {
            color: #9ca3af;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            transition: all 0.3s ease;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #2b63ac;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:disabled {
            background-color: #b5c7e1;
            cursor: not-allowed;
        }

        /* æç¤ºæ¡† (Toast) æ¨£å¼ */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 9999px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: visibility 0s, opacity 0.5s linear;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .summary-card { border-left: 4px solid; padding: 1rem; border-radius: 0.5rem; }
        .summary-behavior { border-color: #60a5fa; background-color: #eff6ff; }
        .summary-thought { border-color: #34d399; background-color: #ecfdf5; }
        .summary-emotion { border-color: #fca5a5; background-color: #fef2f2; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container rounded-2xl shadow-xl flex flex-col gap-8">

        <!-- æ¨™é¡Œèˆ‡èªªæ˜ -->
        <header class="text-center">
            <h1 class="text-3xl font-bold mb-2">æƒ…ç·’ä¸‰è§’å¡ <i class="fas fa-brave"></i></h1>
            <p class="text-gray-500 mb-4">é€™æ˜¯ä¸€å€‹æƒ…ç·’è™•ç†å·¥å…·ï¼Œå®ƒæœƒå¼•å°æ‚¨æ‹†è§£æƒ…ç·’ã€æƒ³æ³•èˆ‡è¡Œç‚ºä¹‹é–“çš„é—œä¿‚ï¼Œå¹«åŠ©æ‚¨æ‰¾åˆ°æ–°çš„æ‡‰å°æ–¹å¼ã€‚é€™å€‹ç·´ç¿’çš„ç›®æ¨™ä¸æ˜¯æ¶ˆé™¤æƒ…ç·’ï¼Œè€Œæ˜¯ç†è§£ä¸¦é‡æ§‹å®ƒå€‘ã€‚</p>
            <div id="step-indicator" class="text-sm font-medium text-gray-400"></div>
        </header>

        <!-- æ­¥é©Ÿå…§å®¹å€å¡Š -->
        <div id="step-content" class="min-h-[300px] flex flex-col justify-center items-center text-center fade-in">
            <!-- é€™è£¡æœƒå‹•æ…‹è¼‰å…¥æ­¥é©Ÿå…§å®¹ -->
        </div>
        
        <!-- å°èˆªæŒ‰éˆ• -->
        <div class="flex justify-between items-center mt-6">
            <button id="prev-btn" class="btn-primary px-6 py-2 rounded-full font-medium transition-all" disabled>
                <i class="fas fa-arrow-left mr-2"></i> ä¸Šä¸€æ­¥
            </button>
            <button id="next-btn" class="btn-primary px-6 py-2 rounded-full font-medium transition-all">
                ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>

    </div>

    <!-- æç¤ºæ¡† (Toast) -->
    <div id="toast"></div>

    <script>
        // ==== æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ç®¡ç† ====
        let currentStep = 0;
        const state = {
            scenario: '',
            thought: '',
            emotion: { name: '', emoji: '', intensity: 5 },
            behavior: '',
            rethinkThought: '',
            rethinkBehavior: '',
        };
        const toastElement = document.getElementById('toast');
        const steps = [
            {
                title: "ç¬¬ä¸€æ­¥ï¼šæè¿°æƒ…å¢ƒ",
                description: "è«‹å›æƒ³ä¸€å€‹è®“æ‚¨æƒ…ç·’æ³¢å‹•çš„å…·é«”å ´æ™¯ã€‚é€™å€‹å ´æ™¯è¶Šå…·é«”ï¼Œå¾ŒçºŒçš„æ‹†è§£æœƒè¶Šæ¸…æ™°ã€‚",
                content: () => `<textarea id="scenario-input" class="input-field h-32 resize-none" placeholder="ä¾‹å¦‚ï¼šè€é—†åœ¨æœƒè­°ä¸Šçªç„¶æ‰¹è©•äº†æˆ‘çš„å°ˆæ¡ˆï¼Œæˆ‘æ„Ÿåˆ°å¾ˆæ²®å–ªã€‚">${state.scenario}</textarea>`
            },
            {
                title: "ç¬¬äºŒæ­¥ï¼šè¦ºå¯Ÿæƒ…ç·’",
                description: "ç•¶æƒ…å¢ƒç™¼ç”Ÿæ™‚ï¼Œæ‚¨æ„Ÿå—åˆ°äº†ä»€éº¼æƒ…ç·’ï¼Ÿè«‹é¸æ“‡ä¸€å€‹æœ€è²¼åˆ‡çš„ï¼Œä¸¦è©•ä¼°å…¶å¼·åº¦ã€‚",
                content: () => `
                    <div class="flex flex-wrap justify-center gap-2 mb-4">
                        <button class="emotion-btn text-4xl p-2 rounded-lg hover:bg-gray-100 transition-colors" data-emoji="ğŸ˜”" data-name="é›£é">ğŸ˜”</button>
                        <button class="emotion-btn text-4xl p-2 rounded-lg hover:bg-gray-100 transition-colors" data-emoji="ğŸ˜ " data-name="æ†¤æ€’">ğŸ˜ </button>
                        <button class="emotion-btn text-4xl p-2 rounded-lg hover:bg-gray-100 transition-colors" data-emoji="ğŸ˜Ÿ" data-name="ç„¦æ…®">ğŸ˜Ÿ</button>
                        <button class="emotion-btn text-4xl p-2 rounded-lg hover:bg-gray-100 transition-colors" data-emoji="ğŸ˜¢" data-name="æ‚²å‚·">ğŸ˜¢</button>
                        <button class="emotion-btn text-4xl p-2 rounded-lg hover:bg-gray-100 transition-colors" data-emoji="ğŸ˜¨" data-name="å®³æ€•">ğŸ˜¨</button>
                        <button class="emotion-btn text-4xl p-2 rounded-lg hover:bg-gray-100 transition-colors" data-emoji="ğŸ˜Œ" data-name="å¹³éœ">ğŸ˜Œ</button>
                        <button class="emotion-btn text-4xl p-2 rounded-lg hover:bg-gray-100 transition-colors" data-emoji="ğŸ¥³" data-name="èˆˆå¥®">ğŸ¥³</button>
                    </div>
                    <div class="text-center mt-6">
                        <div class="mb-2 text-xl font-bold">${state.emotion.emoji ? state.emotion.emoji + ' ' + state.emotion.name : 'è«‹é¸æ“‡æƒ…ç·’'}</div>
                        <label for="intensity-slider" class="block text-gray-500 mb-2">å¼·åº¦ï¼š<span id="intensity-value" class="font-bold text-lg">${state.emotion.intensity}</span> / 10</label>
                        <input type="range" id="intensity-slider" min="1" max="10" value="${state.emotion.intensity}" class="w-full">
                    </div>
                `
            },
            {
                title: "ç¬¬ä¸‰æ­¥ï¼šè¾¨è­˜æƒ³æ³•",
                description: `ç•¶æ‚¨æ„Ÿå—åˆ° **${state.emotion.emoji} ${state.emotion.name}** æ™‚ï¼Œæ‚¨è…¦ä¸­æµ®ç¾äº†ä»€éº¼å¿µé ­ï¼Ÿé€™æ˜¯æœ€å¿«é–ƒéè…¦æµ·çš„è‡ªå‹•åŒ–æ€è€ƒã€‚`,
                content: () => `<textarea id="thought-input" class="input-field h-32 resize-none" placeholder="ä¾‹å¦‚ï¼šæˆ‘æç ¸äº†ã€æˆ‘æ°¸é å­¸ä¸æœƒ...">${state.thought}</textarea>`
            },
            {
                title: "ç¬¬å››æ­¥ï¼šè§€å¯Ÿè¡Œç‚º",
                description: "åœ¨é‚£å€‹ç•¶ä¸‹ï¼Œæ‚¨èº«é«”æ˜¯å¦‚ä½•å›æ‡‰çš„ï¼Ÿæ‚¨åšäº†ä»€éº¼æˆ–æ²’åšä»€éº¼ï¼Ÿ",
                content: () => `<textarea id="behavior-input" class="input-field h-32 resize-none" placeholder="ä¾‹å¦‚ï¼šæˆ‘å¤§è²å›å˜´ã€æˆ‘é–‹å§‹å“­æ³£ã€æˆ‘å‡è£æ²’äº‹...">${state.behavior}</textarea>`
            },
            {
                title: "ç¬¬äº”æ­¥ï¼šæƒ…ç·’é‡æ§‹ (é‡å¡‘)",
                description: "ç¾åœ¨æˆ‘å€‘å·²ç¶“æ‹†è§£äº†é€™å€‹ä¸‰è§’é—œä¿‚ã€‚å¦‚æœæˆ‘å€‘æ”¹è®Šå…¶ä¸­ä¸€è§’ï¼Œæœƒç™¼ç”Ÿä»€éº¼ï¼Ÿè«‹å˜—è©¦é‡æ–°æ€è€ƒï¼Œä¸¦å¯«ä¸‹æ–°çš„æ‡‰å°æ–¹å¼ã€‚",
                content: () => `
                    <div class="space-y-4 w-full">
                        <div class="bg-blue-50 p-4 rounded-lg flex flex-col gap-2">
                            <div class="font-bold">ğŸ§  å¦‚æœç•¶æ™‚çš„æƒ³æ³•ä¸åŒï¼Ÿ</div>
                            <textarea id="rethink-thought" class="input-field h-20 resize-none mt-1" placeholder="ä¾‹å¦‚ï¼šé€™åªæ˜¯è€é—†çµ¦çš„æ„è¦‹ï¼Œä¸ä»£è¡¨æˆ‘èƒ½åŠ›ä¸è¶³ã€‚">${state.rethinkThought}</textarea>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg flex flex-col gap-2">
                            <div class="font-bold">ğŸƒâ€â™€ï¸ å¦‚æœç•¶æ™‚çš„è¡Œç‚ºä¸åŒï¼Ÿ</div>
                            <textarea id="rethink-behavior" class="input-field h-20 resize-none mt-1" placeholder="ä¾‹å¦‚ï¼šæˆ‘æœƒå…ˆæ·±å‘¼å¸ï¼Œç„¶å¾Œä¸»å‹•è©¢å•è€é—†æ›´å¤šç´°ç¯€ã€‚">${state.rethinkBehavior}</textarea>
                        </div>
                    </div>
                `
            },
            {
                title: "ç¬¬å…­æ­¥ï¼šç¸½çµèˆ‡æ´å¯Ÿ",
                description: "æ­å–œæ‚¨å®Œæˆäº†ä¸€æ¬¡æƒ…ç·’æ¢ç´¢ï¼ç¾åœ¨ï¼Œè®“æˆ‘ç‚ºæ‚¨ç¸½çµï¼Œä¸¦æå‡ºä¸€äº›å»ºè­°ã€‚",
                content: () => `
                    <div id="summary-content" class="w-full text-left flex flex-col gap-6">
                        <h3 class="text-2xl font-bold mb-2">åŸå§‹ä¸‰è§’</h3>
                        <div class="summary-card summary-emotion">
                            <h4 class="font-bold text-lg"><i class="fas fa-face-smile mr-2"></i> æƒ…ç·’</h4>
                            <p class="mt-1">${state.emotion.emoji} ${state.emotion.name} (${state.emotion.intensity}/10)</p>
                        </div>
                        <div class="summary-card summary-thought">
                            <h4 class="font-bold text-lg"><i class="fas fa-head-side-virus mr-2"></i> æƒ³æ³•</h4>
                            <p class="mt-1">${state.thought}</p>
                        </div>
                        <div class="summary-card summary-behavior">
                            <h4 class="font-bold text-lg"><i class="fas fa-running mr-2"></i> è¡Œç‚º</h4>
                            <p class="mt-1">${state.behavior}</p>
                        </div>

                        <h3 class="text-2xl font-bold mt-4 mb-2">é‡æ§‹å¾Œçš„å¯èƒ½æ€§</h3>
                        <div class="summary-card summary-thought">
                            <h4 class="font-bold text-lg">ğŸ§  æ–°çš„æƒ³æ³•</h4>
                            <p class="mt-1">${state.rethinkThought || 'æœªå¡«å¯«'}</p>
                        </div>
                        <div class="summary-card summary-behavior">
                            <h4 class="font-bold text-lg">ğŸƒâ€â™€ï¸ æ–°çš„è¡Œç‚º</h4>
                            <p class="mt-1">${state.rethinkBehavior || 'æœªå¡«å¯«'}</p>
                        </div>

                        <h3 class="text-2xl font-bold mt-6 mb-2 flex items-center gap-2">
                            <i class="fas fa-robot text-blue-500"></i>
                            AI æ´å¯Ÿèˆ‡è¡Œå‹•å»ºè­°
                            <i class="fas fa-circle-notch fa-spin ml-2 text-blue-500 text-xl" id="loading-spinner"></i>
                        </h3>
                        <div id="ai-analysis-output" class="bg-gray-50 p-4 rounded-lg prose max-w-none text-left">
                            <p class="text-gray-500">æ­£åœ¨ç‚ºæ‚¨ç”Ÿæˆæ´å¯Ÿå ±å‘Šï¼Œè«‹ç¨å€™...</p>
                        </div>

                        <div id="summary-export-buttons" class="mt-6 flex justify-center gap-4">
                            <button id="export-pdf-btn" class="btn-primary flex items-center gap-2">
                                <i class="fas fa-file-pdf"></i> åŒ¯å‡ºç‚º PDF
                            </button>
                        </div>
                    </div>
                `
            }
        ];

        // ==== å‡½æ•¸ï¼šæ¸²æŸ“ç›®å‰æ­¥é©Ÿ ====
        function renderStep() {
            const stepContent = document.getElementById('step-content');
            stepContent.innerHTML = '';
            const stepData = steps[currentStep];

            const headerHtml = `
                <div class="w-full text-left mb-6 fade-in">
                    <h2 class="text-2xl font-bold">${stepData.title}</h2>
                    <p class="text-gray-500 mt-2">${stepData.description}</p>
                </div>
            `;
            stepContent.insertAdjacentHTML('beforeend', headerHtml);
            stepContent.insertAdjacentHTML('beforeend', stepData.content());
            
            // è¨­å®šäº‹ä»¶ç›£è½å™¨
            if (currentStep === 0) {
                document.getElementById('scenario-input').addEventListener('input', (e) => { state.scenario = e.target.value; validateStep(); });
            } else if (currentStep === 1) {
                document.querySelectorAll('.emotion-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('bg-blue-200'));
                        e.currentTarget.classList.add('bg-blue-200');
                        state.emotion.emoji = e.currentTarget.dataset.emoji;
                        state.emotion.name = e.currentTarget.dataset.name;
                        document.querySelector('#step-content .font-bold').textContent = `${state.emotion.emoji} ${state.emotion.name}`;
                        validateStep();
                    });
                    if (btn.dataset.emoji === state.emotion.emoji) {
                        btn.classList.add('bg-blue-200');
                    }
                });
                const intensitySlider = document.getElementById('intensity-slider');
                intensitySlider.addEventListener('input', (e) => {
                    state.emotion.intensity = e.target.value;
                    document.getElementById('intensity-value').textContent = e.target.value;
                });
            } else if (currentStep === 2) {
                document.getElementById('thought-input').addEventListener('input', (e) => { state.thought = e.target.value; validateStep(); });
            } else if (currentStep === 3) {
                document.getElementById('behavior-input').addEventListener('input', (e) => { state.behavior = e.target.value; validateStep(); });
            } else if (currentStep === 4) {
                document.getElementById('rethink-thought').addEventListener('input', (e) => { state.rethinkThought = e.target.value; validateStep(); });
                document.getElementById('rethink-behavior').addEventListener('input', (e) => { state.rethinkBehavior = e.target.value; validateStep(); });
            } else if (currentStep === 5) {
                // ç¸½çµé é¢ï¼Œç”Ÿæˆ AI æ´å¯Ÿ
                document.getElementById('export-pdf-btn').addEventListener('click', exportAsPDF);
                generateAnalysis();
            }

            // æ›´æ–°å°èˆªæŒ‰éˆ•å’Œæ­¥é©ŸæŒ‡ç¤ºå™¨
            updateNavigation();
            // è¼‰å…¥èˆŠæœ‰è³‡æ–™ä¸¦é©—è­‰
            validateStep();
        }

        // ==== å‡½æ•¸ï¼šé©—è­‰ç•¶å‰æ­¥é©Ÿè³‡æ–™ ====
        function validateStep() {
            let isValid = false;
            if (currentStep === 0) {
                isValid = state.scenario.trim() !== '';
            } else if (currentStep === 1) {
                isValid = state.emotion.emoji !== '';
            } else if (currentStep === 2) {
                isValid = state.thought.trim() !== '';
            } else if (currentStep === 3) {
                isValid = state.behavior.trim() !== '';
            } else if (currentStep === 4) {
                isValid = state.rethinkThought.trim() !== '' || state.rethinkBehavior.trim() !== '';
            } else if (currentStep === 5) {
                isValid = true; // ç¸½çµé é¢æ°¸é æœ‰æ•ˆ
            }
            document.getElementById('next-btn').disabled = !isValid;
            return isValid;
        }

        // ==== å‡½æ•¸ï¼šæ›´æ–°å°èˆªæŒ‰éˆ•ç‹€æ…‹å’Œæ­¥é©ŸæŒ‡ç¤ºå™¨ ====
        function updateNavigation() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const stepIndicator = document.getElementById('step-indicator');

            prevBtn.disabled = currentStep === 0;
            const nextBtnText = currentStep === steps.length - 1 ? 'å®Œæˆ' : 'ä¸‹ä¸€æ­¥';
            nextBtn.innerHTML = `${nextBtnText} <i class="fas fa-arrow-right ml-2"></i>`;
            stepIndicator.textContent = `æ­¥é©Ÿ ${currentStep + 1} / ${steps.length}`;
            
            // å¦‚æœæ˜¯ç¸½çµé é¢ï¼Œä¿®æ”¹æŒ‰éˆ•æ–‡å­—
            if (currentStep === steps.length - 1) {
                nextBtn.innerHTML = `é‡æ–°é–‹å§‹ <i class="fas fa-redo-alt ml-2"></i>`;
            }
            validateStep();
        }

        // ==== å‡½æ•¸ï¼šé¡¯ç¤ºæç¤ºæ¡† (Toast) ====
        function showToast(message, type = 'info') {
            toastElement.textContent = message;
            toastElement.className = `show rounded-full px-6 py-3 text-white shadow-xl ${type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`;
            setTimeout(() => {
                toastElement.className = toastElement.className.replace('show', '');
            }, 3000);
        }

        // ==== å‡½æ•¸ï¼šåŒ¯å‡ºç‚º PDF ====
        async function exportAsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            const element = document.getElementById('summary-content');

            const loadingToast = document.createElement('div');
            loadingToast.textContent = 'æ­£åœ¨æº–å‚™åŒ¯å‡º...';
            loadingToast.id = 'loading-toast';
            loadingToast.className = 'show rounded-full px-6 py-3 text-white shadow-xl bg-blue-500';
            document.body.appendChild(loadingToast);

            try {
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#f0f4f8'
                });

                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 595.28;
                const pageHeight = 841.89;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                doc.save('æƒ…ç·’ä¸‰è§’å¡ç¸½çµ.pdf');
                showToast('å·²åŒ¯å‡ºç‚º PDF', 'success');
            } catch (err) {
                showToast('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
                console.error('åŒ¯å‡º PDF å¤±æ•—:', err);
            } finally {
                loadingToast.remove();
            }
        }

        // ==== å‡½æ•¸ï¼šå‘¼å« AI é€²è¡Œåˆ†æ ====
        async function generateAnalysis() {
            const loadingSpinner = document.getElementById('loading-spinner');
            const outputDiv = document.getElementById('ai-analysis-output');
            
            loadingSpinner.classList.remove('hidden');
            outputDiv.innerHTML = '<p class="text-gray-500 animate-pulse">æ­£åœ¨ç‚ºæ‚¨ç”Ÿæˆæ´å¯Ÿå ±å‘Šï¼Œè«‹ç¨å€™...</p>';
            
            try {
                const prompt = `
                è«‹æ‰®æ¼”ä¸€ä½å°ˆæ¥­çš„å¿ƒç†æ•™ç·´ã€‚æˆ‘ä½¿ç”¨äº†ã€Œæƒ…ç·’ä¸‰è§’å¡ã€å·¥å…·ï¼Œä¸¦å¡«å¯«äº†ä»¥ä¸‹å…§å®¹ã€‚è«‹æ ¹æ“šé€™äº›è³‡è¨Šï¼Œæä¾›ä¸€ä»½è©³ç´°çš„æ´å¯Ÿå ±å‘Šå’Œå…·é«”çš„è¡Œå‹•å»ºè­°ã€‚å ±å‘Šæ‡‰åŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š

                1.  **æƒ…å¢ƒç¸½çµ**ï¼šç°¡è¦é‡è¿°æˆ‘é‡åˆ°çš„æƒ…å¢ƒã€æˆ‘çš„åŸå§‹æƒ³æ³•ã€æƒ…ç·’å’Œè¡Œç‚ºï¼Œä¸¦åˆ†æé€™ä¸‰è€…ä¹‹é–“çš„é—œè¯æ€§ã€‚
                2.  **æ–°è§€é»åˆ†æ**ï¼šåˆ†ææˆ‘é‡æ§‹å¾Œçš„ã€Œæ–°æƒ³æ³•ã€å’Œã€Œæ–°è¡Œç‚ºã€å¦‚ä½•æ‰“ç ´èˆŠæœ‰çš„æ¨¡å¼ã€‚
                3.  **è¡Œå‹•å»ºè­°**ï¼šæ ¹æ“šæˆ‘çš„æ–°è§€é»ï¼Œæä¾› 1-2 æ¢å…·é«”çš„ã€å¯å¯¦è¸çš„è¡Œå‹•å»ºè­°ã€‚
                4.  **åƒ¹å€¼ç¸½çµ**ï¼šè§£é‡‹é€™å€‹ã€Œæƒ…ç·’ä¸‰è§’ã€éç¨‹å°æˆ‘çš„æ„ç¾©ï¼Œä»¥åŠå®ƒèƒ½å¹«åŠ©æˆ‘å¸¶ä¾†ä»€éº¼æ”¹è®Šã€‚

                ä»¥ä¸‹æ˜¯æˆ‘çš„å¡«å¯«å…§å®¹ï¼š
                æƒ…å¢ƒ (Scenario): ${state.scenario}
                æƒ…ç·’ (Emotion): ${state.emotion.name} (${state.emotion.intensity}/10)
                åŸå§‹æƒ³æ³• (Original Thought): ${state.thought}
                åŸå§‹è¡Œç‚º (Original Behavior): ${state.behavior}
                é‡æ§‹å¾Œçš„æ–°æƒ³æ³• (New Thought): ${state.rethinkThought}
                é‡æ§‹å¾Œçš„æ–°è¡Œç‚º (New Behavior): ${state.rethinkBehavior}
                `;

                // å‘¼å« Gemini API
                const chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "" 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    outputDiv.innerHTML = `<div class="prose max-w-none">${marked.parse(text)}</div>`;
                } else {
                    outputDiv.innerHTML = '<p class="text-red-500">ç„¡æ³•ç”Ÿæˆæ´å¯Ÿå ±å‘Šï¼Œè«‹é‡è©¦ã€‚</p>';
                }

            } catch (error) {
                console.error("AI Generation failed:", error);
                outputDiv.innerHTML = '<p class="text-red-500">ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯æˆ–ç¨å¾Œé‡è©¦ã€‚</p>';
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }
        
        // ç‚ºäº†è®“ AI è¼¸å‡º Markdown èƒ½æ­£ç¢ºæ¸²æŸ“ï¼Œæˆ‘å€‘éœ€è¦å¼•å…¥ä¸€å€‹ Markdown æ¸²æŸ“åº«
        const markedScript = document.createElement('script');
        markedScript.src = "https://cdn.jsdelivr.net/npm/marked/marked.min.js";
        document.head.appendChild(markedScript);

        // ==== å°èˆªæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨ ====
        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentStep > 0) {
                currentStep--;
                renderStep();
            }
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentStep === steps.length - 1) {
                // é‡æ–°é–‹å§‹
                currentStep = 0;
                Object.keys(state).forEach(key => {
                    if (typeof state[key] === 'object') {
                        state[key] = { name: '', emoji: '', intensity: 5 };
                    } else {
                        state[key] = '';
                    }
                });
                renderStep();
                showToast('å·²é‡è¨­ï¼Œè®“æˆ‘å€‘é‡æ–°é–‹å§‹å§ï¼');
            } else if (validateStep()) {
                currentStep++;
                renderStep();
            } else {
                showToast('è«‹å®Œæˆæ­¤æ­¥é©Ÿçš„æ‰€æœ‰å…§å®¹ã€‚');
            }
            saveState();
        });

        // ==== å‡½æ•¸ï¼šæ›´æ–°ç‹€æ…‹ä¸¦å„²å­˜åˆ° localStorage ====
        function saveState() {
            localStorage.setItem('emotionTriangleState', JSON.stringify(state));
        }

        // ==== å‡½æ•¸ï¼šåˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ ====
        function initializeApp() {
            const savedState = localStorage.getItem('emotionTriangleState');
            if (savedState) {
                Object.assign(state, JSON.parse(savedState));
            }
            renderStep();
        }
        
        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        initializeApp();
    </script>
</body>
</html>
