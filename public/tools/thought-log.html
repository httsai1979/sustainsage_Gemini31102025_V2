<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>思維紀錄表 | 優化版</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter & Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- jsPDF and html2canvas for export functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary-color: #4A6C56;
            --secondary-color: #C7A87A;
            --accent-color: #7DA781;
            --bg-light: #F6F2EA;
            --text-dark: #1F2933;
            --border-color: #E5DED0;
            --card-bg: #fff;
            --font-family: 'Noto Sans TC', 'Inter', sans-serif;
        }

        body {
            font-family: var(--font-family);
            color: var(--text-dark);
            background-color: var(--bg-light);
        }

        .form-input, .form-textarea {
            width: 100%; padding: 0.75rem; border-radius: 0.75rem;
            border: 1px solid var(--border-color); background-color: var(--bg-light);
            transition: all 0.2s ease-in-out; font-size: 1rem;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none; border-color: var(--primary-color);
            background-color: var(--card-bg); box-shadow: 0 0 0 2px var(--primary-color);
        }
        .form-textarea { min-height: 100px; resize: vertical; }

        /* Thought Trap Cards */
        .trap-card {
            border: 2px solid var(--border-color);
            transition: all 0.2s ease-in-out;
        }
        .trap-card.selected {
            border-color: var(--secondary-color);
            background-color: #F3EBDA;
            transform: scale(1.03);
        }
        
        /* Tooltip */
        .tooltip {
            position: absolute; background-color: var(--text-dark); color: #fff;
            padding: 10px; border-radius: 8px; z-index: 100; font-size: 0.9em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 250px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Toast Notification */
        #toast {
            visibility: hidden; min-width: 250px; background-color: var(--text-dark);
            color: #fff; text-align: center; border-radius: 1rem;
            padding: 1rem; position: fixed; z-index: 1001; bottom: 2rem;
            left: 50%; transform: translateX(-50%); font-weight: bold;
        }
        #toast.show { visibility: visible; animation: fadeIn 0.5s, fadeOut 0.5s 2.5s; }
        @keyframes fadeOut { from { bottom: 2rem; opacity: 1; } to { bottom: 0; opacity: 0; } }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app-container" class="max-w-4xl mx-auto">
        <!-- App content will be rendered here -->
    </div>
    <div id="toast"></div>
</body>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const appContainer = document.getElementById('app-container');
            const toastElement = document.getElementById('toast');

            // --- State Management ---
            let currentView = 'welcome'; // 'welcome', 'tool', 'dashboard'
            let currentStep = 0;
            let currentLog = {};
            let savedLogs = JSON.parse(localStorage.getItem('thoughtLogsV2')) || [];
            let isTour = false;

            // --- Data Definitions ---
            const thoughtTraps = {
                'catastrophising': { name: '災難化', icon: 'fa-bolt-lightning', desc: '將小問題誇大成無法挽回的災難。' },
                'mind-reading': { name: '讀心術', icon: 'fa-user-secret', desc: '臆測別人對你的負面想法。' },
                'overgeneralization': { name: '過度概括', icon: 'fa-infinity', desc: '從單一事件得出一個概括性的結論。' },
                'all-or-nothing': { name: '全有或全無', icon: 'fa-adjust', desc: '將事物視為非黑即白，沒有中間地帶。' },
                'personalization': { name: '個人化', icon: 'fa-hand-point-up', desc: '將負面事件過度歸咎於自己。' },
                'filtering': { name: '選擇性過濾', icon: 'fa-filter', desc: '只關注負面細節，忽略正面部分。' }
            };

            const exampleLog = {
                event: '我給朋友發了訊息，但對方沒有在預期時間內回覆。',
                thought: '他肯定是在生我的氣，不想理我了。',
                emotion: '焦慮',
                initialIntensity: 80,
                thoughtTrap: 'mind-reading',
                evidenceFor: '他平時都回得很快。',
                evidenceAgainst: '他可能正在忙工作，或者手機沒電了。我們昨天還聊得很開心。',
                alternativeThought: '我不能確定他為什麼沒回，但沒有證據表明他在生氣。我可以等他有空了再看看。',
                finalIntensity: 30,
                actionStep: '先專注於我自己的事，而不是一直盯著手機。'
            };

            // --- Main Render Function ---
            function renderApp() {
                appContainer.innerHTML = '';
                let content = '';
                if (currentView === 'welcome') {
                    content = renderWelcomeView();
                } else if (currentView === 'tool') {
                    content = renderToolView();
                } else if (currentView === 'dashboard') {
                    content = renderDashboardView();
                }
                appContainer.innerHTML = content;
                addEventListeners();

                if (currentView === 'dashboard') {
                    renderDashboardCharts();
                }
            }

            // --- View Renderers ---
            function renderWelcomeView() {
                return `
                    <div class="bg-white p-8 rounded-2xl shadow-lg text-center animate-fadeIn">
                        <i class="fas fa-brain text-5xl text-blue-500 mb-4"></i>
                        <h1 class="text-3xl font-bold mb-2">腦中總是有個聲音在困擾你嗎？</h1>
                        <p class="text-gray-600 mb-6">讓我們一起來看看它究竟想說什麼。</p>
                        <div class="flex flex-col md:flex-row gap-4 justify-center">
                            <button id="start-new-btn" class="w-full md:w-auto bg-blue-500 text-white font-bold py-3 px-6 rounded-full hover:bg-blue-600 transition-transform hover:scale-105">
                                <i class="fas fa-plus mr-2"></i>開始一次新的紀錄
                            </button>
                            <button id="tour-btn" class="w-full md:w-auto bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-full hover:bg-gray-300 transition-transform hover:scale-105">
                                <i class="fas fa-magic mr-2"></i>用一個範例快速體驗
                            </button>
                        </div>
                         <button id="show-dashboard-btn" class="mt-6 text-blue-500 hover:underline">
                            <i class="fas fa-chart-line mr-2"></i>查看我的思維儀表板
                        </button>
                    </div>
                `;
            }

            function renderToolView() {
                const stepContent = [
                    // Step 0: Event & Thought
                    `
                        <h2 class="text-2xl font-bold text-center">步驟 1/3：發生了什麼？</h2>
                        <div class="space-y-6">
                            <div>
                                <label class="font-bold">事件 (Situation)</label>
                                <p class="text-sm text-gray-500 mb-2">請客觀描述，不加猜測。例如：「會議上我被主管打斷發言。」</p>
                                <textarea id="event-input" class="form-textarea" placeholder="發生了什麼事？">${currentLog.event || ''}</textarea>
                            </div>
                            <div>
                                <label class="font-bold">自動化思維 (Thought)</label>
                                <p class="text-sm text-gray-500 mb-2">腦中第一個跳出來的念頭是什麼？</p>
                                <textarea id="thought-input" class="form-textarea" placeholder="我當時的想法是...">${currentLog.thought || ''}</textarea>
                            </div>
                        </div>
                    `,
                    // Step 1: Emotion & Thought Trap
                    `
                        <h2 class="text-2xl font-bold text-center">步驟 2/3：感覺如何？</h2>
                        <div class="space-y-6">
                            <div>
                                <label class="font-bold">情緒 (Emotion)</label>
                                <input id="emotion-input" class="form-input" placeholder="例如：焦慮、沮喪、憤怒..." value="${currentLog.emotion || ''}">
                            </div>
                            <div>
                                <label class="font-bold">情緒強度 (0-100%)</label>
                                <input type="range" id="initial-intensity" class="w-full" min="0" max="100" value="${currentLog.initialIntensity || 50}">
                                <p class="text-center font-bold text-lg">${currentLog.initialIntensity || 50}%</p>
                            </div>
                            <div>
                                <label class="font-bold">這個念頭聽起來像哪個思維陷阱？</label>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    ${Object.keys(thoughtTraps).map(key => `
                                        <div id="trap-${key}" class="trap-card p-4 rounded-xl cursor-pointer text-center ${currentLog.thoughtTrap === key ? 'selected' : ''}">
                                            <i class="fas ${thoughtTraps[key].icon} text-3xl mb-2 text-violet-500"></i>
                                            <h4 class="font-bold">${thoughtTraps[key].name}</h4>
                                            <p class="text-xs text-gray-500">${thoughtTraps[key].desc}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `,
                    // Step 2: Challenge & Reframe
                    `
                        <h2 class="text-2xl font-bold text-center">步驟 3/3：挑戰與重構</h2>
                        <div class="space-y-6">
                            <div>
                                <label class="font-bold">支持這個負面想法的證據？</label>
                                <textarea id="evidence-for-input" class="form-textarea" placeholder="有哪些事實支持我的想法？">${currentLog.evidenceFor || ''}</textarea>
                            </div>
                            <div>
                                <label class="font-bold">反駁這個負面想法的證據？</label>
                                <textarea id="evidence-against-input" class="form-textarea" placeholder="有哪些事實反駁或不支持我的想法？">${currentLog.evidenceAgainst || ''}</textarea>
                            </div>
                             <div>
                                <label class="font-bold">替代思維 (Alternative Thought)</label>
                                <p class="text-sm text-gray-500 mb-2">綜合所有證據後，一個更平衡、客觀的想法是什麼？</p>
                                <textarea id="alternative-thought-input" class="form-textarea" placeholder="一個更合理的解釋是...">${currentLog.alternativeThought || ''}</textarea>
                            </div>
                            <div>
                                <label class="font-bold">相信新想法後，情緒強度降至？ (0-100%)</label>
                                <input type="range" id="final-intensity" class="w-full" min="0" max="100" value="${currentLog.finalIntensity || 50}">
                                <p class="text-center font-bold text-lg">${currentLog.finalIntensity || 50}%</p>
                            </div>
                            <div>
                                <label class="font-bold">我可以採取的一個小行動 (可選)</label>
                                <input id="action-step-input" class="form-input" placeholder="例如：明天找主管約時間聊聊" value="${currentLog.actionStep || ''}">
                            </div>
                        </div>
                    `
                ];

                return `
                    <div class="bg-white p-8 rounded-2xl shadow-lg animate-fadeIn">
                        <div class="relative pt-1 mb-6">
                            <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-blue-200">
                                <div style="width:${((currentStep + 1) / 3) * 100}%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 transition-all duration-500"></div>
                            </div>
                        </div>
                        ${stepContent[currentStep]}
                        <div class="flex justify-between mt-8">
                            <button id="prev-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-full ${currentStep === 0 ? 'invisible' : ''}">上一步</button>
                            <button id="next-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-full">${currentStep === 2 ? '完成並儲存' : '下一步'}</button>
                        </div>
                    </div>
                `;
            }

            function renderDashboardView() {
                const trapCounts = savedLogs.reduce((acc, log) => {
                    if(log.thoughtTrap) acc[log.thoughtTrap] = (acc[log.thoughtTrap] || 0) + 1;
                    return acc;
                }, {});
                const mostCommonTrapKey = Object.keys(trapCounts).sort((a,b) => trapCounts[b] - trapCounts[a])[0];
                let insightHTML = '<p>繼續記錄，讓我們一起發現您的思維模式！</p>';
                if (mostCommonTrapKey) {
                    insightHTML = `<p>我們發現，「<strong>${thoughtTraps[mostCommonTrapKey].name}</strong>」是您最常遇到的思維夥伴。下次當它出現時，也許可以多加留意喔！</p>`;
                }

                return `
                    <div class="bg-white p-8 rounded-2xl shadow-lg animate-fadeIn space-y-8">
                        <div class="text-center">
                            <h1 class="text-3xl font-bold">我的思維儀表板</h1>
                            <p class="text-gray-600">這裡是您思維成長的總覽。</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-4 bg-gray-50 rounded-xl">
                                <h3 class="font-bold text-center mb-2">情緒強度平均變化</h3>
                                <canvas id="trends-chart"></canvas>
                            </div>
                             <div class="p-4 bg-gray-50 rounded-xl">
                                <h3 class="font-bold text-center mb-2">最常見的思維陷阱</h3>
                                <canvas id="traps-chart"></canvas>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-violet-100 text-violet-800 rounded-xl text-center">
                            <h3 class="font-bold mb-2"><i class="fas fa-lightbulb mr-2"></i>智慧洞察</h3>
                            ${insightHTML}
                        </div>

                        <div>
                            <h3 class="text-xl font-bold mb-4">歷史紀錄</h3>
                            <div id="history-list" class="space-y-3">
                                ${savedLogs.length > 0 ? savedLogs.map((log, index) => `
                                    <div class="p-4 border rounded-lg flex justify-between items-center">
                                        <div>
                                            <p class="font-semibold">${log.event}</p>
                                            <p class="text-sm text-gray-500">${new Date(log.date).toLocaleDateString()}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold ${log.finalIntensity < log.initialIntensity ? 'text-green-500' : 'text-red-500'}">
                                                ${log.initialIntensity}% → ${log.finalIntensity}%
                                            </p>
                                            <span class="text-xs px-2 py-1 bg-gray-200 rounded-full">${thoughtTraps[log.thoughtTrap]?.name || '無'}</span>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-center text-gray-500">暫無紀錄</p>'}
                            </div>
                        </div>
                        
                        <div class="flex justify-center gap-4">
                            <button id="back-to-welcome-btn" class="bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-full">返回主畫面</button>
                            <button id="export-pdf-btn" class="bg-green-500 text-white font-bold py-3 px-6 rounded-full">匯出成長報告</button>
                        </div>
                    </div>
                `;
            }
            
            function renderDashboardCharts() {
                // Trends Chart
                const trendsCtx = document.getElementById('trends-chart')?.getContext('2d');
                if (trendsCtx) {
                    const initialAvg = savedLogs.reduce((sum, log) => sum + Number(log.initialIntensity), 0) / (savedLogs.length || 1);
                    const finalAvg = savedLogs.reduce((sum, log) => sum + Number(log.finalIntensity), 0) / (savedLogs.length || 1);
                    new Chart(trendsCtx, {
                        type: 'bar',
                        data: {
                            labels: ['原始強度', '替代後強度'],
                            datasets: [{
                                label: '平均情緒強度',
                                data: [initialAvg, finalAvg],
                                backgroundColor: ['#ef4444', '#22c55e'],
                            }]
                        },
                        options: { scales: { y: { beginAtZero: true, max: 100 } } }
                    });
                }

                // Traps Chart
                const trapsCtx = document.getElementById('traps-chart')?.getContext('2d');
                if (trapsCtx) {
                    const trapCounts = savedLogs.reduce((acc, log) => {
                        if(log.thoughtTrap) acc[log.thoughtTrap] = (acc[log.thoughtTrap] || 0) + 1;
                        return acc;
                    }, {});
                    new Chart(trapsCtx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(trapCounts).map(key => thoughtTraps[key].name),
                            datasets: [{
                                data: Object.values(trapCounts),
                                backgroundColor: ['#8b5cf6', '#ec4899', '#f97316', '#06b6d4', '#f59e0b', '#6366f1'],
                            }]
                        },
                    });
                }
            }

            // --- Event Handlers ---
            function addEventListeners() {
                // Welcome View
                document.getElementById('start-new-btn')?.addEventListener('click', () => {
                    currentLog = { id: Date.now(), date: new Date().toISOString() };
                    currentStep = 0;
                    currentView = 'tool';
                    renderApp();
                });
                document.getElementById('tour-btn')?.addEventListener('click', () => {
                    isTour = true;
                    currentLog = { ...exampleLog, id: Date.now(), date: new Date().toISOString() };
                    currentStep = 0;
                    currentView = 'tool';
                    renderApp();
                    setTimeout(() => showTooltip(document.getElementById('event-input'), '你看，我們只記錄客觀事實，不加上自己的猜測。'), 500);
                });
                document.getElementById('show-dashboard-btn')?.addEventListener('click', () => {
                    currentView = 'dashboard';
                    renderApp();
                });
                
                // Tool View
                document.getElementById('prev-btn')?.addEventListener('click', () => {
                    saveStepData();
                    currentStep--;
                    renderApp();
                });
                document.getElementById('next-btn')?.addEventListener('click', handleNext);

                document.querySelectorAll('.trap-card').forEach(card => {
                    card.addEventListener('click', () => {
                        document.querySelectorAll('.trap-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                        if (isTour) setTimeout(() => showTooltip(card, '這個念頭聽起來是不是有點像「讀心術」呢？'), 500);
                    });
                });
                
                const initialIntensity = document.getElementById('initial-intensity');
                if(initialIntensity) initialIntensity.addEventListener('input', e => e.target.nextElementSibling.textContent = `${e.target.value}%`);
                
                const finalIntensity = document.getElementById('final-intensity');
                if(finalIntensity) finalIntensity.addEventListener('input', e => e.target.nextElementSibling.textContent = `${e.target.value}%`);

                // Dashboard View
                document.getElementById('back-to-welcome-btn')?.addEventListener('click', () => {
                    currentView = 'welcome';
                    renderApp();
                });
                document.getElementById('export-pdf-btn')?.addEventListener('click', exportToPDF);
            }

            function saveStepData() {
                if (currentStep === 0) {
                    currentLog.event = document.getElementById('event-input').value;
                    currentLog.thought = document.getElementById('thought-input').value;
                } else if (currentStep === 1) {
                    currentLog.emotion = document.getElementById('emotion-input').value;
                    currentLog.initialIntensity = document.getElementById('initial-intensity').value;
                    const selectedTrap = document.querySelector('.trap-card.selected');
                    if (selectedTrap) currentLog.thoughtTrap = selectedTrap.id.replace('trap-', '');
                } else if (currentStep === 2) {
                    currentLog.evidenceFor = document.getElementById('evidence-for-input').value;
                    currentLog.evidenceAgainst = document.getElementById('evidence-against-input').value;
                    currentLog.alternativeThought = document.getElementById('alternative-thought-input').value;
                    currentLog.finalIntensity = document.getElementById('final-intensity').value;
                    currentLog.actionStep = document.getElementById('action-step-input').value;
                }
            }

            function handleNext() {
                saveStepData();
                if (currentStep < 2) {
                    currentStep++;
                    renderApp();
                    if (isTour && currentStep === 1) setTimeout(() => showTooltip(document.querySelector('.trap-card'), '點擊卡片來選擇一個思維陷阱。'), 500);
                    if (isTour && currentStep === 2) setTimeout(() => showTooltip(document.getElementById('evidence-against-input'), '試著找出反駁原始想法的證據，這是改變的關鍵！'), 500);
                } else {
                    // Save log
                    const existingIndex = savedLogs.findIndex(log => log.id === currentLog.id);
                    if (existingIndex > -1) {
                        savedLogs[existingIndex] = currentLog;
                    } else {
                        savedLogs.push(currentLog);
                    }
                    localStorage.setItem('thoughtLogsV2', JSON.stringify(savedLogs));
                    showToast('紀錄已儲存！', 'success');
                    currentView = 'dashboard';
                    renderApp();
                }
            }

            async function exportToPDF() {
                showToast('正在生成您的成長報告...', 'info');
                const dashboardNode = document.querySelector('#app-container > div');
                const canvas = await html2canvas(dashboardNode, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save('我的思維成長報告.pdf');
                showToast('報告匯出成功！', 'success');
            }
            
            // BUG FIX: Added missing showTooltip function
            function showTooltip(element, text) {
                // Remove any existing tooltips
                document.querySelectorAll('.tooltip').forEach(t => t.remove());
                
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.textContent = text;
                document.body.appendChild(tooltip);
                
                const rect = element.getBoundingClientRect();
                tooltip.style.left = `${rect.left + window.scrollX}px`;
                tooltip.style.top = `${rect.bottom + window.scrollY + 10}px`;

                // Remove tooltip after a delay
                setTimeout(() => {
                    tooltip.remove();
                }, 4000);
            }

            function showToast(message, type = 'success') {
                toastElement.textContent = message;
                toastElement.style.backgroundColor = type === 'success' ? 'var(--accent-color)' : '#ef4444';
                toastElement.classList.add('show');
                setTimeout(() => { toastElement.classList.remove('show'); }, 3000);
            }

            // --- Initial Load ---
            renderApp();
        });
    </script>
</body>
</html>
